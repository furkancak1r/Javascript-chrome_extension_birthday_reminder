const clientId = '559438139153-dpl1b0n0h8s2pokpcuuft50mfro2kqq4.apps.googleusercontent.com';
const clientSecret = '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';
const redirectUri = chrome.identity.getRedirectURL();

function getUserInfo(accessToken) {
  fetch(`https://www.googleapis.com/oauth2/v1/userinfo?alt=json&access_token=${accessToken}`, {
    method: 'GET'
  })
    .then(response => response.json())
    .then(data => {
      chrome.runtime.onMessage.addListener(function (request, sender, sendResponse) {
        if (request.method === 'getEmail') {
          var user_email = data.email;
          sendResponse({ email: user_email });

        }
      });
      chrome.runtime.sendMessage({
        method: 'getUserInfo',
        name: data.name,
        email: data.email
      });
    })
    .catch(error => console.error(error));
}

chrome.runtime.onMessage.addListener(function (request, sender, sendResponse) {
  if (request.method === 'getAuthToken') {
    chrome.identity.launchWebAuthFlow({
      url: `https://accounts.google.com/o/oauth2/auth?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&scope=https://www.googleapis.com/auth/userinfo.email&prompt=select_account`,
      interactive: true
    }, function (responseUrl) {
      const code = responseUrl.substring(responseUrl.indexOf('code=') + 5);
      fetch('https://accounts.google.com/o/oauth2/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `code=${code}&client_id=${clientId}&client_secret=${clientSecret}&redirect_uri=${encodeURIComponent(redirectUri)}&grant_type=authorization_code`
      })
        .then(response => response.json())
        .then(data => {

          getUserInfo(data.access_token);
          sendResponse(data.access_token);
        })
        .catch(error => console.error(error));
    });
    return true;
  }
});
