// Oturum açma işlemi başarılı
// Burada diğer işlemlerinizi yapabilirsiniz
function checkInputs() {
  let inputs = document.querySelectorAll('input');
  let hasEmptyInput = false;

  inputs.forEach(function (input) {
    if (!input.value) {
      input.style.borderColor = 'red';
      input.animate([
        { transform: 'translateX(-10px)' },
        { transform: 'translateX(10px)' },
        { transform: 'translateX(-10px)' },
        { transform: 'translateX(10px)' },
        { transform: 'translateX(0px)' },
      ], {
        duration: 500,
        iterations: 1
      }).onfinish = function () {
        setTimeout(function () {
          input.style.animation = '';
        }, 2000);
      };
      hasEmptyInput = true;
    } else {
      input.style.borderColor = '';
      input.style.animation = '';
    }
  });

  return !hasEmptyInput;
}

function handleInputChange(event) {
  const input = event.target;
  if (input.value) {
    input.style.borderColor = '';
    input.style.animation = '';
  }
}

let inputs = document.querySelectorAll('input');
inputs.forEach(function (input) {
  input.onchange = handleInputChange;
});


chrome.runtime.onMessage.addListener(function (request, sender, sendResponse) {
  if (request.method == 'getUserInfo') {
    if(request.email !== undefined && request.email !== null){
      var user_email = request.email;
    } 
    else {
      alert("E-posta geçersiz!");
      return;
    }
    const showButton = document.getElementById('show-button');
    const birthdayList = document.getElementById('birthday-list');
    let isShowingBirthdays = false;
    showButton.addEventListener('click', () => {
      if (isShowingBirthdays) {
        birthdayList.innerHTML = '';
        showButton.innerText = 'Kişileri Göster';
        isShowingBirthdays = false;
      } else {
        fetch(`https://www.furkancakr.online/api_birthday_reminder/birthday_info_user/${user_email}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Sunucudan hata alındı.');
            }
            return response.json();
          })
          .then(data => {
            console.log(data);
            let listHtml = '<ul>';
            data.forEach(person => {
              listHtml += `<li>${person.first_name} ${person.last_name} - ${person.birthday_day}/${person.birthday_month}/${person.birthday_year}</li>`;
            });
            listHtml += '</ul>';
            birthdayList.innerHTML = listHtml;
            showButton.innerText = 'Kişileri Gizle';
            isShowingBirthdays = true;
          })
          .catch(error => {
            console.error('Doğum günü bilgileri alınırken hata oluştu:', error);
          });
      }
    });

    document.getElementById("submit-button").addEventListener("click", function () {
      if (!checkInputs()) {
        return;
      }

      let firstName = document.getElementById("first-name").value;
      let lastName = document.getElementById("last-name").value;
      let birthday = document.getElementById("birthday").value;
      let [year, month, day] = birthday.split("-");

      fetch("https://www.furkancakr.online/api_birthday_reminder/birthday_info_user", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          user_email: user_email,
          first_name: firstName,
          last_name: lastName,
          birthday_day: day,
          birthday_month: month,
          birthday_year: year
        })
      })
        .then(response => response.json())
        .then(data => {
          console.log(data);
          alert("Kaydedildi!");
        })
        .catch(error => console.error(error));
    });

  }
});


let access_token;
// Check if an access token already exists
chrome.storage.local.get('access_token', function (result) {
  if (result.access_token) {
    // Access token exists
    // Hide login button and show form
    document.getElementById('form-container').style.display = 'block';
    document.getElementById('login').style.display = 'none';
  } else {
    // Access token does not exist
    // Show only login button
    document.getElementById('form-container').style.display = 'none';
    document.getElementById('login').style.display = 'block';
  }
});

document.getElementById('login').addEventListener('click', function () {
  chrome.runtime.sendMessage({ method: 'getAuthToken' }, function (token) {
    if (chrome.runtime.lastError) {
      console.log(chrome.runtime.lastError.message);
      return;
    }
    // alert('Oturum açma işlemi başarılı!');
    console.log("Oturum açma işlemi başarılı!");

    // Formu görünür hale getirme
    document.getElementById('form-container').style.display = 'block';

    // Oturum Aç butonunu gizleme
    document.getElementById('login').style.display = 'none';

    // Save access_token to local storage
    chrome.storage.local.set({ access_token: token });
  });
});
document.getElementById('logout-button').addEventListener('click', function () {

  // Retrieve access_token from local storage
  chrome.storage.local.get('access_token', function (result) {
    if (result.access_token) {
      // Access token exists
      // Remove cached auth token
      chrome.identity.removeCachedAuthToken({ token: result.access_token }, function () {
        console.log('Oturum kapatıldı!');

        // Remove access_token from local storage
        chrome.storage.local.remove(['access_token']);
      });
    }
  });

  // Formu gizleme
  document.getElementById('form-container').style.display = 'none';

  // Oturum Aç butonunu görünür hale getirme
  document.getElementById('login').style.display = 'block';
});